url = "/search"
layout = "default"
title = "Search Results"
meta_title = "搜尋結果"
==
<?php
function onInit(){
    $this->page->title = "搜尋結果";
    $this->len_limit_before = 50;
    $this->len_limit_after = 150;
    $this->result_limit = 10;
}

function onStart(){
    $keyword = $_GET['q'] ?? "";
    $this['keyword'] = $keyword;
    $results = [];
    if (!$keyword) return false;

    //Make Query on Articles
    $articles = $this->getArticleItems($keyword);
    foreach ($articles as $article) array_push($results, $article);

    //Sort Results
    usort($results, function ($a, $b){
        if ($a['score1'] < $b['score1']) return +1;
        if ($a['score1'] > $b['score1']) return -1;
        if ($a['score2'] < $b['score2']) return +1;
        if ($a['score2'] > $b['score2']) return -1;
        return 0;
    });

    //Display Results
    $this['results'] = array_slice($results, 0, $this->result_limit);
}

function getArticleItems($keyword){
    $c = "xc_339b11b769ad43c49be16953e7738827c";
    $r = "xc_339b11b769ad43c49be16953e7738827r";
    $query = "
        SELECT $c.title, $c.slug, $r.content_group, $r.content_value 
        FROM $c, $r
        WHERE $c.id = $r.host_id
        AND ($c.title ILIKE :k OR $r.content_value ILIKE :k)
        ORDER BY slug ASC
    ";
    $query_results = Db::select($query, ["k" => "%".$keyword."%"]);

    //Check Each Article
    $articles = [];
    $prev_slug = null;
    $keyword = strtolower($keyword);
    foreach ($query_results as $i => $result){

        //Add Article Matching Record
        $score1 = 0;
        $title_lower = strtolower($result->title);
        if (strtolower($title_lower) === $keyword){
            $score1 = 2;
        }else if (substr_count($title_lower, $keyword)){
            $score1 = 1;
        }
        if ($prev_slug !== $result->slug){
            array_push($articles, [
                'title' => $result->title,
                'slug' => $result->slug,
                'score1' => $score1,
                'score2' => 0,
                'match' => "",
            ]);
        }

        //Add Content Matching Record
        $article_index = array_key_last($articles);
        $content_value = json_decode($result->content_value);
        if ($result->content_group == "header"){
            //Header
            $content = $content_value->text;
        }else if ($result->content_group == "html" || $result->content_group == 'richtext'){
            //HTML
            $content = strip_tags($content_value->content);
        }else if ($result->content_group == "markdown"){
            //Markdown
            $content = $content_value->content;
        }
        $articles[$article_index]['score2'] += (substr_count(strtolower($content), $keyword));

        //Find First Matching
        if (!$articles[$article_index]['match']){
            $strpos = mb_strpos(strtolower($content), $keyword);
            if ($strpos !== false){
                $len_before = $strpos;
                $len_after = mb_strlen($content) - mb_strlen($keyword) - $strpos;
                $truncate_before = max(0, $len_before - $this->len_limit_before);
                $truncate_after = max(0, $len_after - $this->len_limit_after);
                $prefix = $truncate_before ? '...' : '';
                $suffix = $truncate_after ? '...' : '';
                $content = mb_substr($content, $truncate_before, mb_strlen($content) - $truncate_before - $truncate_after);
                $articles[$article_index]['match'] = $prefix.$content.$suffix;
            }
        }

        //Proceed
        $prev_slug = $result->slug;
    }
    return $articles;
}
?>
==
<article class="my-content">

    {% if keyword is not empty %}

        <h1>搜尋: {{ keyword }}</h1>

        {% if results|length == 0 %}
            <div>沒有結果。</div>
        {% endif %}
        
        {% for result in results %}
            <div class="card mt-2">
                <div class="card-body py-2">
                    <strong>
                        <a href="/a/{{ result.slug }}">{{ result.title }}</a>
                    </strong>
                    <div>
                        {{ result.match }}
                    </div>
                </div>
           </div>
        {% endfor %}

    {% else %}

        <h1>搜尋</h1>

    {% endif %}

    <form class="d-flex mt-2" role="search" action="/search">
        <input class="form-control"
            type="search" name="q" value="{{keyword}}" placeholder="搜尋" aria-label="搜尋"
        />
        <button class="btn btn-secondary text-nowrap ms-2" type="submit">
            搜尋
        </button>
    </form>

</article>